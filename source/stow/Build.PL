#!/usr/bin/env perl
# This file is part of GNU Stow.
#
# GNU Stow is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# GNU Stow is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see https://www.gnu.org/licenses/.

use strict;
use warnings;

# Need this for 'dirname' when validating 'bin/stow'
use File::Basename;

use Module::Build;

use constant IS_WIN32 => $^O eq 'MSWin32';

# These are required by the test suite.
use lib "t";
use lib "bin";

sub create_build_script {
    print "Creating build configuration for 'Stow' module.\n";

    my $build = Module::Build->new(
        module_name => 'Stow',
        keywords    => [ qw/stow symlink software package management install/ ],
        license     => 'gpl',

        # Module::Build forces us to use v1.4 of the CPAN Meta Spec:
        # https://rt.cpan.org/Ticket/Display.html?id=71502
        # 'meta-spec' =>  {
        #     version => '2.0',
        #     url     => 'http://search.cpan.org/perldoc?CPAN::Meta::Spec',
        # },
        meta_add => {
            resources => {
                license => 'https://www.gnu.org/licenses/gpl-2.0.html' ,
                homepage => 'https://savannah.gnu.org/projects/stow',

                # Module::Build forces us to use v1.4 of the CPAN Meta Spec:
                # https://rt.cpan.org/Ticket/Display.html?id=71502
                # bugtracker => {
                #     web    => 'http://rt.cpan.org/Public/Dist/Display.html?Name=Stow',
                #     mailto => 'stow-devel@gnu.org',
                # },
                #bugtracker => 'http://rt.cpan.org/Public/Dist/Display.html?Name=Stow',

                # Module::Build forces us to use v1.4 of the CPAN Meta Spec:
                # https://rt.cpan.org/Ticket/Display.html?id=71502
                # repository => {
                #     url  => 'git://git.savannah.gnu.org/stow.git',
                #     web  => 'https://savannah.gnu.org/git/?group=stow',
                #     type => 'git',
                # },
                repository => 'git://git.savannah.gnu.org/stow.git',
            },
        },

        requires => {
            'perl'                          => '5.006',
            'Carp'                          => 0,
            'IO::File'                      => 0,
            (IS_WIN32 ? ('Inline::C'        => 0) : ()),
            (IS_WIN32 ? ('ExtUtils::PL2Bat' => 0) : ()),
            (IS_WIN32 ? ('Win32::Mutex'     => 0) : ())
        },

        script_files => [ 'bin/stow', 'bin/chkstow' ],

        all_from => 'lib/Stow.pm.in',

        configure_requires => {
            'Module::Build' => 0,
        },

        test_requires => {
            'Test::More'                        => 0,
            'Test::Output'                      => 0,
            'Test::Exception'                   => 0,
            'IO::Scalar'                        => 0,
            'TAP::Formatter::JUnit'             => 0,
            'Devel::Cover::Report::Coveralls'   => 0,
        }
    );

    print "Generating build script for 'Stow' module.\n";
    $build->create_build_script;

    print "Created build script for 'Stow' module.\n";
}

sub check_stow_binary {
    print "Checking 'bin/stow' for 'use lib' directive.\n";

    my $buildDir = dirname(__FILE__);
    my $binStow = "$buildDir/bin/stow";

    unless (-e "$binStow") {
        $binStow = "$buildDir/../bin/stow";
    }

    unless (-e "$binStow") {
        print "Failed to find 'bin/stow' file: '$binStow'";
        return 0;
    }

    open my $stowFileHandle, '<', "$binStow"
        or die "Cannot open 'bin/stow' file: $!\n";

    my $useLibExists = 0;
    while(<$stowFileHandle>) {
        if ($_ =~ /^use lib/) {
            $useLibExists = 1;
            last;
        }
    }

    if ($useLibExists == 0) {
        print <<'EOF';
------
WARNING: 'bin/stow' contains 'use lib' line which could interfere
with CPAN-style installation via 'Module::Build'. To avoid this,
you can run './configure' with parameters which results in
'--with-pmdir' value being in Perl's built-in @INC, and then run
'make' (NOT 'make install') to regenerate bin/stow, e.g.

    eval `perl -V:siteprefix`
    ./configure --prefix=$siteprefix && make

or

    ./configure --with-pmdir=`PERL5LIB= perl -le 'print $INC[0]'` && make

Then re-run this script. Note that these parameters are chosen purely to
regenerate 'bin/stow' without a 'use lib' line, so don't run 'make install'
while Stow is configured in this way unless you really want an installation
using these parameters.
------
EOF
    } else {
        print("Validated that Stow library is built correctly.\n");
    }
}

check_stow_binary();
create_build_script();
